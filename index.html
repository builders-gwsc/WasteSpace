<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Griffin Waste â€“ Sign In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- silence local favicon 404 -->
  <link rel="icon" href="data:," />
  <style>
    :root{ --gw-red:#e30613; --ink:#222; --muted:#666; --card:#fff; --bg:#f5f5f5; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:Arial, sans-serif; background:var(--bg); color:var(--ink); }
    .wrap{
      max-width: 960px; margin: 40px auto; padding: 20px;
    }
    header{
      background:#fff; border:1px solid #e7e7e7; border-radius:12px;
      padding:18px 20px; box-shadow:0 2px 6px rgba(0,0,0,.06);
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{ font-weight:800; letter-spacing:.3px; color:var(--gw-red); }
    .card{
      margin-top:16px; background:var(--card); border:1px solid #ddd; border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.06); padding:18px;
    }
    .tabs{ display:flex; gap:8px; margin-bottom:12px; }
    .tab-btn{
      padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius:10px; cursor:pointer; font-weight:700;
    }
    .tab-btn.active{ background:var(--gw-red); color:#fff; border-color:var(--gw-red); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label{ display:block; font-size:.9rem; color:#333; margin:10px 0 4px; }
    input, select{
      width:100%; max-width:340px; padding:10px 12px; border:1px solid #ccc; border-radius:8px;
    }
    button{
      padding:10px 16px; border:none; border-radius:10px; font-weight:800; cursor:pointer;
    }
    .primary{ background:var(--gw-red); color:#fff; }
    .muted{ color:var(--muted); font-size:.9rem; }
    .err{ color:#b00020; font-weight:700; margin-top:8px; }
    .ok{ color:#0a7a32; font-weight:700; margin-top:8px; }
    .two-cols{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width: 880px){ .two-cols{ grid-template-columns:1fr 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Griffin Waste â€“ Portal Access</div>
      <div class="muted">Sign in to continue</div>
    </header>

    <div class="card">
      <div class="tabs">
        <button id="loginTab"  class="tab-btn active">Log In</button>
        <button id="signupTab" class="tab-btn">Sign Up</button>
      </div>

      <!-- LOGIN -->
      <section id="loginSection">
        <div class="two-cols">
          <div>
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" placeholder="name@company.com" autocomplete="email" />
          </div>
          <div>
            <label for="loginPass">Password</label>
            <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button id="loginBtn" class="primary">Log In</button>
          <span class="muted">Youâ€™ll be redirected to your Hub.</span>
        </div>
        <div id="loginMsg" class=""></div>
      </section>

      <!-- SIGNUP -->
      <section id="signupSection" style="display:none;">
        <div class="two-cols">
          <div>
            <label for="suName">Full Name</label>
            <input id="suName" type="text" placeholder="First Last" autocomplete="name" />
          </div>
          <div>
            <label for="suRole">Role</label>
            <select id="suRole">
              <option value="driver">Driver</option>
              <option value="manager">Manager</option>
              <option value="gm">GM</option>
            </select>
          </div>
        </div>
        <div class="two-cols">
          <div>
            <label for="suEmail">Email</label>
            <input id="suEmail" type="email" placeholder="name@company.com" autocomplete="email" />
          </div>
          <div>
            <label for="suPass">Password (min 6 chars)</label>
            <input id="suPass" type="password" placeholder="Create password" autocomplete="new-password" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button id="signupBtn" class="primary">Create Account</button>
          <span class="muted">New users will land in the Hub after signup.</span>
        </div>
        <div id="signupMsg"></div>
      </section>
    </div>

    <p class="muted" style="margin-top:12px;">
      Tip: Managers/GM can set or change roles later in Admin (coming soon). For now, choose the appropriate role on signup.
    </p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // ðŸ”‘ Your Firebase config (unchanged, including storage bucket host)
    const firebaseConfig = {
      apiKey: "AIzaSyBTFuNqxrFLPE6TIRPXhwryKq3eRSt7PEY",
      authDomain: "daily-objectives-8922e.firebaseapp.com",
      databaseURL: "https://daily-objectives-8922e-default-rtdb.firebaseio.com",
      projectId: "daily-objectives-8922e",
      storageBucket: "daily-objectives-8922e.firebasestorage.app",
      messagingSenderId: "450105668325",
      appId: "1:450105668325:web:e64427c9316403195fda0c",
      measurementId: "G-9EKLEJJN73"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    // Tabs
    const loginTab  = document.getElementById('loginTab');
    const signupTab = document.getElementById('signupTab');
    const loginSection  = document.getElementById('loginSection');
    const signupSection = document.getElementById('signupSection');

    function showLogin(){
      loginTab.classList.add('active'); signupTab.classList.remove('active');
      loginSection.style.display = '';  signupSection.style.display = 'none';
      clearMsgs();
    }
    function showSignup(){
      signupTab.classList.add('active'); loginTab.classList.remove('active');
      signupSection.style.display = '';  loginSection.style.display  = 'none';
      clearMsgs();
    }
    loginTab.addEventListener('click', showLogin);
    signupTab.addEventListener('click', showSignup);

    // UI helpers
    function setMsg(el, text, ok=false){
      el.textContent = text || '';
      el.className = ok ? 'ok' : 'err';
    }
    function clearMsgs(){
      setMsg(document.getElementById('loginMsg'), '');
      setMsg(document.getElementById('signupMsg'), '');
    }

    // Redirect if already logged in
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        // ensure user doc exists (backfill if an older account logs in)
        const uref = doc(db, 'users', user.uid);
        const snap = await getDoc(uref);
        if(!snap.exists()){
          await setDoc(uref, {
            email: user.email || '',
            name: user.displayName || '',
            role: 'driver',           // default if unknown; can be changed later
            createdAt: serverTimestamp()
          });
        }
        window.location.href = 'hub.html'; // âœ… unified hub
      }
    });

    // LOGIN
    document.getElementById('loginBtn').addEventListener('click', async ()=>{
      clearMsgs();
      const email = (document.getElementById('loginEmail').value || '').trim();
      const pass  = (document.getElementById('loginPass').value  || '').trim();
      const msgEl = document.getElementById('loginMsg');

      if(!email || !pass){ setMsg(msgEl, 'Enter email and password.'); return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        // onAuthStateChanged will redirect
      }catch(err){
        setMsg(msgEl, err.message || 'Login failed.');
      }
    });

    // SIGNUP
    document.getElementById('signupBtn').addEventListener('click', async ()=>{
      clearMsgs();
      const name  = (document.getElementById('suName').value  || '').trim();
      const role  = (document.getElementById('suRole').value  || 'driver');
      const email = (document.getElementById('suEmail').value || '').trim();
      const pass  = (document.getElementById('suPass').value  || '').trim();
      const msgEl = document.getElementById('signupMsg');

      if(!email || !pass){ setMsg(msgEl, 'Enter email and password.'); return; }
      if(pass.length < 6){ setMsg(msgEl, 'Password must be at least 6 characters.'); return; }

      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        if(name){
          await updateProfile(cred.user, { displayName: name });
        }
        // Create user doc with chosen role
        const uref = doc(db, 'users', cred.user.uid);
        await setDoc(uref, {
          email, name, role,
          createdAt: serverTimestamp()
        });
        setMsg(msgEl, 'Account created. Redirectingâ€¦', true);
        // onAuthStateChanged will redirect
      }catch(err){
        setMsg(msgEl, err.message || 'Signup failed.');
      }
    });
  </script>
</body>
</html>
